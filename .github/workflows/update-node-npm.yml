# Workflow to automatically detect new Node.js LTS versions and create a PR to update the project

name: üîÑ Auto-update Node.js version

on:
  schedule:
    # Monthly: First Saturday at 09:00 Spain (08:00 UTC)
    # Runs on days 1-7 of each month, but only if it's Saturday (day 6)
    - cron: '0 8 1-7 * 6'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-node:
    name: üîç Check and update Node.js version
    runs-on: ubuntu-latest

    steps:
      - name: üîÄ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_WORKFLOW }}

      - name: üåê Get Node.js LTS versions info
        id: node-versions
        run: |
          # Fetch Node.js release schedule
          RELEASES=$(curl -s https://raw.githubusercontent.com/nodejs/Release/main/schedule.json)

          # Fetch all Node.js versions
          ALL_VERSIONS=$(curl -s https://nodejs.org/dist/index.json)

          # Get current date
          CURRENT_DATE=$(date +%Y-%m-%d)

          # Find active LTS versions (started and not ended)
          ACTIVE_LTS=$(echo "$RELEASES" | jq -r --arg date "$CURRENT_DATE" '
            to_entries |
            map(select(
              .value.start <= $date and
              .value.end >= $date and
              .value.lts != null and
              .value.lts <= $date
            )) |
            map(.key | ltrimstr("v") | tonumber) |
            sort |
            .[-2:]
          ')

          echo "Active LTS versions: $ACTIVE_LTS"

          # Get the two active LTS major versions for the matrix
          LTS_OLDEST=$(echo "$ACTIVE_LTS" | jq '.[0]')
          LTS_LATEST=$(echo "$ACTIVE_LTS" | jq '.[1]')

          echo "LTS oldest: $LTS_OLDEST"
          echo "LTS latest: $LTS_LATEST"

          # Get the latest version of the newest LTS
          LATEST_VERSION=$(echo "$ALL_VERSIONS" | jq -r --argjson major "$LTS_LATEST" '
            map(select(.version | startswith("v\($major)."))) |
            .[0].version |
            ltrimstr("v")
          ')

          echo "Latest LTS version: $LATEST_VERSION"

          # Get npm version bundled with this Node version
          NPM_VERSION=$(echo "$ALL_VERSIONS" | jq -r --arg ver "v$LATEST_VERSION" '
            map(select(.version == $ver)) |
            .[0].npm
          ')

          echo "Bundled npm version: $NPM_VERSION"

          # Set outputs
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "npm_version=$NPM_VERSION" >> $GITHUB_OUTPUT
          echo "lts_oldest=$LTS_OLDEST" >> $GITHUB_OUTPUT
          echo "lts_latest=$LTS_LATEST" >> $GITHUB_OUTPUT
          echo "matrix=[ $LTS_OLDEST, $LTS_LATEST ]" >> $GITHUB_OUTPUT

      - name: üìñ Get current versions
        id: current-versions
        run: |
          # Check if .nvmrc exists
          if [ ! -f .nvmrc ]; then
            echo "‚ùå .nvmrc file not found"
            echo "has_nvmrc=false" >> $GITHUB_OUTPUT
            echo "current_node=unknown" >> $GITHUB_OUTPUT
          else
            echo "has_nvmrc=true" >> $GITHUB_OUTPUT
            CURRENT_NODE=$(cat .nvmrc | tr -d 'v' | tr -d '\n')
            echo "Current Node version: $CURRENT_NODE"
            echo "current_node=$CURRENT_NODE" >> $GITHUB_OUTPUT
          fi

          # Check if package.json has engines.node
          if [ ! -f package.json ] || [ "$(jq -r '.engines.node // empty' package.json)" == "" ]; then
            echo "‚ùå package.json engines.node not found"
            echo "has_engines=false" >> $GITHUB_OUTPUT
            echo "current_npm=unknown" >> $GITHUB_OUTPUT
          else
            echo "has_engines=true" >> $GITHUB_OUTPUT
            CURRENT_NPM=$(jq -r '.engines.npm // "unknown"' package.json)
            echo "Current npm version: $CURRENT_NPM"
            echo "current_npm=$CURRENT_NPM" >> $GITHUB_OUTPUT
          fi

          # Check if node.yml exists
          if [ ! -f .github/workflows/node.yml ]; then
            echo "‚ùå node.yml workflow not found"
            echo "has_node_yml=false" >> $GITHUB_OUTPUT
          else
            echo "has_node_yml=true" >> $GITHUB_OUTPUT
          fi

      - name: üîÑ Check if update is needed
        id: check-update
        run: |
          LATEST="${{ steps.node-versions.outputs.latest_version }}"
          CURRENT="${{ steps.current-versions.outputs.current_node }}"

          # Get current date in DD-MM-YYYY format
          echo "date=$(date +%d-%m-%Y)" >> $GITHUB_OUTPUT

          if [ "$LATEST" != "$CURRENT" ]; then
            echo "Update needed: $CURRENT -> $LATEST"
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "Already up to date: $CURRENT"
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: üìù Update .nvmrc
        if: steps.check-update.outputs.update_needed == 'true' && steps.current-versions.outputs.has_nvmrc == 'true'
        run: |
          echo "v${{ steps.node-versions.outputs.latest_version }}" > .nvmrc
          echo "Updated .nvmrc to v${{ steps.node-versions.outputs.latest_version }}"

      - name: üìù Update package.json engines
        if: steps.check-update.outputs.update_needed == 'true' && steps.current-versions.outputs.has_engines == 'true'
        run: |
          # Update node and npm versions preserving tab indentation
          jq --tab '.engines.node = "${{ steps.node-versions.outputs.latest_version }}" | .engines.npm = "${{ steps.node-versions.outputs.npm_version }}"' package.json > package.json.tmp
          mv package.json.tmp package.json

          echo "Updated package.json engines"
          cat package.json | jq '.engines'

      - name: üìù Update node.yml matrix
        if: steps.check-update.outputs.update_needed == 'true' && steps.current-versions.outputs.has_node_yml == 'true'
        run: |
          # Update the node-version matrix in node.yml
          sed -i "s/node-version: \[.*\]/node-version: ${{ steps.node-versions.outputs.matrix }}/" .github/workflows/node.yml

          echo "Updated node.yml matrix"
          grep "node-version:" .github/workflows/node.yml

      - name: üöÄ Create Pull Request
        if: |
          steps.check-update.outputs.update_needed == 'true' &&
          (steps.current-versions.outputs.has_nvmrc == 'true' ||
           steps.current-versions.outputs.has_engines == 'true' ||
           steps.current-versions.outputs.has_node_yml == 'true')
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_WORKFLOW }}
          commit-message: "build(node): update Node.js from ${{ steps.current-versions.outputs.current_node }} to ${{ steps.node-versions.outputs.latest_version }}"
          title: "build(node): update Node.js from ${{ steps.current-versions.outputs.current_node }} to ${{ steps.node-versions.outputs.latest_version }}"
          body: |
            # build(node): update Node.js from ${{ steps.current-versions.outputs.current_node }} to ${{ steps.node-versions.outputs.latest_version }}

            | ‚è±Ô∏è Time | üìä Priority | üìè Size | üìÖ Date |
            |---------|-------------|---------|---------|
            | 5min    | P2          | XS      | ${{ steps.check-update.outputs.date }} |

            ## üîß Build Type
            - [x] Dependency update
            - [x] Build configuration
            - [x] CI/CD configuration

            ## üìù Summary

            Automatic update of Node.js version detected by the `update-node-npm.yml` workflow.

            | Package | Previous | New |
            |---------|----------|-----|
            | `node` | `${{ steps.current-versions.outputs.current_node }}` | `${{ steps.node-versions.outputs.latest_version }}` |
            | `npm` | `${{ steps.current-versions.outputs.current_npm }}` | `${{ steps.node-versions.outputs.npm_version }}` |

            ## üìã Changes Made

            - Updated `.nvmrc` from `v${{ steps.current-versions.outputs.current_node }}` to `v${{ steps.node-versions.outputs.latest_version }}`
            - Updated `package.json` engines.node from `${{ steps.current-versions.outputs.current_node }}` to `${{ steps.node-versions.outputs.latest_version }}`
            - Updated `package.json` engines.npm from `${{ steps.current-versions.outputs.current_npm }}` to `${{ steps.node-versions.outputs.npm_version }}`
            - Updated `.github/workflows/node.yml` matrix to `${{ steps.node-versions.outputs.matrix }}`

            ## üß™ Tests

            - [ ] Build completes successfully
            - [ ] All tests pass
            - [ ] Development workflow still works

            ## üîó References

            - [Node.js Release Schedule](https://nodejs.org/en/about/releases/)
            - Generated automatically by `update-node-npm.yml` workflow
          branch: dependabot/npm_and_yarn/node-${{ steps.node-versions.outputs.latest_version }}
          delete-branch: true
          labels: |
            build
            dependencies
            automated

      - name: üìä Summary
        run: |
          echo "## Node.js Update Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Versions" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Current Node | ${{ steps.current-versions.outputs.current_node }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Latest LTS | ${{ steps.node-versions.outputs.latest_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Current npm | ${{ steps.current-versions.outputs.current_npm }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Latest npm | ${{ steps.node-versions.outputs.npm_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Update needed | ${{ steps.check-update.outputs.update_needed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Matrix | ${{ steps.node-versions.outputs.matrix }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files" >> $GITHUB_STEP_SUMMARY
          echo "| File | Exists |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| .nvmrc | ${{ steps.current-versions.outputs.has_nvmrc }} |" >> $GITHUB_STEP_SUMMARY
          echo "| package.json (engines) | ${{ steps.current-versions.outputs.has_engines }} |" >> $GITHUB_STEP_SUMMARY
          echo "| node.yml | ${{ steps.current-versions.outputs.has_node_yml }} |" >> $GITHUB_STEP_SUMMARY
